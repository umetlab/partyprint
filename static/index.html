<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PartyPrint Demo</title>
  <style>
    body { font-family: system-ui, sans-serif; text-align: center; margin: 2rem auto; max-width: 640px; background:#111; color:#eee; }
    video, img, canvas { width: 100%; max-width: 320px; margin: 1rem auto; border-radius: 8px; display: block; }
    button { padding: .6rem 1.2rem; border: none; background: #ff6600; color: #fff; border-radius: 6px; cursor: pointer; font-weight:600; }
    button:hover { background:#ff8800; }
    button:disabled { opacity: .6; cursor: not-allowed; }
    input[type=text] { padding: .5rem; border: 1px solid #444; border-radius: 4px; width: 200px; margin: .5rem; background:#222; color:#eee;}
    .queue, .gallery { text-align: left; margin-top: 2rem; border-top: 1px solid #333; padding-top: 1rem; }
    .job { margin: .25rem 0; }
    .gallery-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: .5rem; }
    .gallery-grid img { width: 100%; border-radius: 6px; }
    h3 { margin-bottom: .5rem; color:#ff9900; }
  </style>
</head>
<body>
  <h1>üéÉ PartyPrint</h1>
  <p>Snap ‚Üí Upload ‚Üí Print ‚Üí Share!</p>

  <input type="text" id="username" placeholder="Your name (optional)" />
  <video id="preview" autoplay playsinline muted></video>
  <button id="captureBtn">üì∏ Take Photo</button>

  <p>or upload from your device:</p>
  <input type="file" id="file" accept="image/*" />
  <button id="sendBtn">Upload</button>

  <div id="result"></div>

  <div class="queue">
    <h3>üñ®Ô∏è Print Queue</h3>
    <div id="queueList">Loading...</div>
  </div>

  <div class="gallery">
    <h3>üéâ Party Gallery</h3>
    <div id="galleryGrid" class="gallery-grid">Loading...</div>
  </div>

  <script>
    const video = document.getElementById('preview');
    const captureBtn = document.getElementById('captureBtn');
    const sendBtn = document.getElementById('sendBtn');
    const fileInput = document.getElementById('file');
    let lastJobId = null;

    async function initCamera() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = stream;
      } catch {
        document.getElementById('captureBtn').style.display = 'none';
      }
    }

    captureBtn.addEventListener('click', async () => {
      const canvas = document.createElement('canvas');
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      canvas.getContext('2d').drawImage(video, 0, 0);
      const blob = await new Promise(r => canvas.toBlob(r, 'image/jpeg', 0.9));
      const formData = new FormData();
      formData.append('image', blob, `capture_${Date.now()}.jpg`);
      formData.append('user', document.getElementById('username').value || 'Anonymous');
      await upload(formData);
    });

    sendBtn.addEventListener('click', async () => {
      if (!fileInput.files.length) return alert('Select an image first!');
      const formData = new FormData();
      formData.append('image', fileInput.files[0]);
      formData.append('user', document.getElementById('username').value || 'Anonymous');
      await upload(formData);
    });

    async function upload(formData) {
      sendBtn.disabled = true;
      captureBtn.disabled = true;
      const res = await fetch('/upload', { method: 'POST', body: formData });
      const data = await res.json();
      if (data.ok) {
        lastJobId = data.id;
        document.getElementById('result').innerHTML = `
          <p>‚úÖ Uploaded by <strong>${data.user}</strong></p>
          <img src="${data.path}" />
          <button id="printBtn">üñ®Ô∏è Print This Photo</button>
          <div id="printStatus"></div>
        `;
        document.getElementById('printBtn').addEventListener('click', triggerPrint);
        refreshQueue();
        refreshGallery();
      } else {
        alert('Upload failed');
      }
      sendBtn.disabled = false;
      captureBtn.disabled = false;
    }

    async function triggerPrint() {
      const statusEl = document.getElementById('printStatus');
      statusEl.textContent = '‚è≥ Sending to printer...';
      const res = await fetch(`/print/${lastJobId}`, { method: 'POST' });
      const data = await res.json();
      if (data.ok) {
        statusEl.textContent = 'üñ®Ô∏è Sent! Your photo is printing.';
      } else {
        statusEl.textContent = '‚ö†Ô∏è Print failed.';
      }
      refreshQueue();
    }

    async function refreshQueue() {
      const res = await fetch('/queue');
      const data = await res.json();
      const html = data.jobs.map(
        (j, i) =>
          `<div class="job ${j.done ? 'done' : ''}">#${i+1} ‚Äî ${j.filename} (${j.user || 'Anonymous'})</div>`
      ).join('');
      document.getElementById('queueList').innerHTML = html || 'No jobs yet.';
    }

    async function refreshGallery() {
      try {
        const res = await fetch('/gallery');
        const data = await res.json();
        const images = data.images || [];
        if (!images.length) {
          document.getElementById('galleryGrid').innerHTML = '<p>No photos yet.</p>';
          return;
        }
        const html = images.map(
          img => `
            <div class="photo">
              <img src="${img.path}" alt="${img.user}" title="${img.user}" />
              <div style="font-size:.8rem; text-align:center; color:#666;">${img.user}</div>
            </div>`
        ).join('');
        document.getElementById('galleryGrid').innerHTML = html;
      } catch (err) {
        document.getElementById('galleryGrid').innerHTML = '<p>‚ö†Ô∏è Gallery error</p>';
      }
    }

    initCamera();
    refreshQueue();
    refreshGallery();
    setInterval(refreshQueue, 5000);
    setInterval(refreshGallery, 7000);
  </script>
</body>
</html>
